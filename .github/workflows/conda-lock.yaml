name: update conda lockfile
on:
  push:
    paths:
      - .github/workflows/conda-lock.yaml
      - conda/environment.yml
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@main
    - name: install conda-lock with micromamba
      uses: mamba-org/setup-micromamba@main
      with:
        environment-name: locker
        create-args: conda-lock
        cache-environment: true
    - name: run conda-lock
      shell: bash -el {0}
      run: |
        cd conda
        conda-lock --platform linux-64 --kind env
        mv conda-linux-64.lock.yml ../binder/environment.yml
    - name: commit changes to tracked files
      run: |
        if [[ $(git ls-files --modified) ]]; then
          git config --global user.name 'actions-bot'
          git config --global user.email '58130806+actions-bot@users.noreply.github.com'
          git commit --all --message "[bot] autogenerated conda-lock files"
          git push
        fi
